---
import { Icon } from 'astro-icon/components'

// Wir definieren keine Props mehr, da der State rein clientseitig verwaltet wird
---

<button 
  id="theme-toggle" 
  class="theme-toggle theme-toggle--rotate" 
  aria-label="Theme wechseln" 
  title="Design wechseln"
>
  <div class="icon-stack">
    <!-- System Icon -->
    <span class="icon-wrapper icon-system">
      <Icon name="mingcute:brightness-line" class="theme-icon" />
    </span>
    <!-- Light Icon -->
    <span class="icon-wrapper icon-light">
      <Icon name="mingcute:sun-line" class="theme-icon" />
    </span>
    <!-- Dark Icon -->
    <span class="icon-wrapper icon-dark">
      <Icon name="mingcute:moon-line" class="theme-icon" />
    </span>
  </div>
</button>

<style>
  /* Basis Button Styles */
  .theme-toggle {
    background: none;
    border: 1px solid var(--border-farbe-hellgrau);
    cursor: pointer;
    padding: var(--abstand-s);
    color: var(--textfarbe);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%; /* Runde Buttons für bessere Animation */
    width: 3rem;
    height: 3rem;
    overflow: hidden; /* Wichtig für Animations-Überlappung */
    position: relative;
    background-color: var(--hintergrundfarbe);
    box-shadow: var(--schatten-standard);
    transition: background-color 0.3s ease, box-shadow 0.3s ease; /* Übergang für Button selbst */
  }

  .theme-toggle:hover {
    background-color: var(--hintergrund-hellgrau);
  }

  .icon-stack {
    position: relative;
    width: 1.5em;
    height: 1.5em;
    display: grid;
    place-items: center;
  }

  .theme-icon {
    width: 1.5em;
    height: 1.5em;
    display: block;
  }

  /* Basis Wrapper: Absolute Positionierung für Übereinanderlagern */
  .icon-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    
    opacity: 0; /* Standard: Unsichtbar */
    pointer-events: none; /* Interaktionen mit inaktiven Icons verhindern */
  }

  /* =========================================
     LOGIK: Welches Icon ist aktiv? (Sichtbarkeit)
     ========================================= */
  /* Das aktive Icon wird sichtbar gemacht */
  .theme-toggle:not([data-state]) .icon-system, /* Default: System ist aktiv wenn kein data-state gesetzt */
  .theme-toggle[data-state='system'] .icon-system,
  .theme-toggle[data-state='light'] .icon-light,
  .theme-toggle[data-state='dark'] .icon-dark {
    opacity: 1;
    pointer-events: auto; /* Aktives Icon ist interaktiv */
  }


  /* =========================================
     ANIMATION: ROTATE & SCALE
     ========================================= */
  .theme-toggle--rotate .icon-wrapper {
    transition: transform 0.4s cubic-bezier(0.4, 0.0, 0.2, 1), opacity 0.2s linear;
    transform: scale(0) rotate(-90deg); /* Inaktive Icons sind klein und gedreht */
  }

  /* Aktive Icons der Rotate-Variante */
  .theme-toggle--rotate:not([data-state]) .icon-system,
  .theme-toggle--rotate[data-state='system'] .icon-system,
  .theme-toggle--rotate[data-state='light'] .icon-light,
  .theme-toggle--rotate[data-state='dark'] .icon-dark {
    transform: scale(1) rotate(0deg); /* Aktive Icons sind normal und ungedreht */
  }

</style>

<script>
  const STORAGE_KEY = 'theme-preference'
  const THEME_STATES = ['system', 'light', 'dark'] as const
  type ThemeState = (typeof THEME_STATES)[number]

  // Helfer: Theme auf HTML Element anwenden (für tokens.css)
  const applyThemeToDocument = (state: ThemeState) => {
    const doc = document.documentElement
    if (state === 'system') {
      doc.removeAttribute('data-theme')
    } else {
      doc.setAttribute('data-theme', state)
    }
  }

  // Helfer: State auf Button anwenden (für Icon-Wechsel & Title-Text)
  const updateButtonState = (button: HTMLElement, state: ThemeState) => {
    button.setAttribute('data-state', state)
    const titles = {
      system: 'Design: System (Auto)',
      light: 'Design: Hell',
      dark: 'Design: Dunkel'
    }
    button.setAttribute('title', titles[state])
  }

  document.addEventListener('DOMContentLoaded', () => {
    const button = document.getElementById('theme-toggle')
    if (!button) return

    // 1. Initialen State laden
    const savedState = localStorage.getItem(STORAGE_KEY) as ThemeState | null
    let currentState: ThemeState = savedState && THEME_STATES.includes(savedState) 
      ? savedState 
      : 'system'

    // 2. Initial anwenden
    applyThemeToDocument(currentState)
    updateButtonState(button, currentState)

    // 3. Click Handler
    button.addEventListener('click', () => {
      // Zyklus: system -> light -> dark -> system
      const currentIndex = THEME_STATES.indexOf(currentState)
      const nextIndex = (currentIndex + 1) % THEME_STATES.length
      currentState = THEME_STATES[nextIndex]

      // Speichern & Anwenden
      localStorage.setItem(STORAGE_KEY, currentState)
      applyThemeToDocument(currentState)
      updateButtonState(button, currentState)
    })
  })
</script>