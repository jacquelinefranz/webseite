---
import { Icon } from 'astro-icon/components'

// Wir definieren keine Props mehr, da der State rein clientseitig verwaltet wird
---

<button id="theme-toggle" aria-label="Theme wechseln" title="Design wechseln">
  <!-- Alle drei Icons werden gerendert, aber per CSS gesteuert -->
  <span class="icon-wrapper icon-system">
    <Icon name="mingcute:brightness-line" class="theme-icon" />
  </span>
  <span class="icon-wrapper icon-light">
    <Icon name="mingcute:sun-line" class="theme-icon" />
  </span>
  <span class="icon-wrapper icon-dark">
    <Icon name="mingcute:moon-line" class="theme-icon" />
  </span>
</button>

<style>
  button {
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--abstand-s);
    color: var(--textfarbe);
    transition: var(--uebergang-standard);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--abstand-s);
    position: relative;
    /* Verhindert Layout-Verschiebungen beim Laden */
    min-width: 2.5em; 
    min-height: 2.5em;
  }

  button:hover {
    background-color: var(--hintergrund-hellgrau);
  }

  .theme-icon {
    width: 1.5em;
    height: 1.5em;
  }

  /* Standardmäßig alle ausblenden */
  .icon-wrapper {
    display: none;
  }

  /* 
   * Logik für die Sichtbarkeit basierend auf dem Attribut am BUTTON 
   * Default (kein Attribut oder 'system') -> System Icon
   */
  button:not([data-state]),
  button[data-state='system'] .icon-system {
    display: block;
  }

  /* Wenn Light gewählt ist -> Light Icon */
  button[data-state='light'] .icon-light {
    display: block;
  }
  /* System Icon dann ausblenden (überschreibt die :not Regel falls nötig, hier aber explizit) */
  button[data-state='light'] .icon-system {
    display: none;
  }

  /* Wenn Dark gewählt ist -> Dark Icon */
  button[data-state='dark'] .icon-dark {
    display: block;
  }
  button[data-state='dark'] .icon-system {
    display: none;
  }
</style>

<script>
  const STORAGE_KEY = 'theme-preference'
  const THEME_STATES = ['system', 'light', 'dark'] as const
  type ThemeState = (typeof THEME_STATES)[number]

  // Helfer: Theme auf HTML Element anwenden (für tokens.css)
  const applyThemeToDocument = (state: ThemeState) => {
    const doc = document.documentElement
    if (state === 'system') {
      doc.removeAttribute('data-theme')
    } else {
      doc.setAttribute('data-theme', state)
    }
  }

  // Helfer: State auf Button anwenden (für Icon-Wechsel)
  const updateButtonState = (button: HTMLElement, state: ThemeState) => {
    button.setAttribute('data-state', state)
    // Optional: Title Attribut für Hover-Info anpassen
    const titles = {
      system: 'Design: System (Auto)',
      light: 'Design: Hell',
      dark: 'Design: Dunkel'
    }
    button.setAttribute('title', titles[state])
  }

  document.addEventListener('DOMContentLoaded', () => {
    const button = document.getElementById('theme-toggle')
    if (!button) return

    // 1. Initialen State laden
    const savedState = localStorage.getItem(STORAGE_KEY) as ThemeState | null
    let currentState: ThemeState = savedState && THEME_STATES.includes(savedState) 
      ? savedState 
      : 'system'

    // 2. Initial anwenden
    applyThemeToDocument(currentState)
    updateButtonState(button, currentState)

    // 3. Click Handler
    button.addEventListener('click', () => {
      // Zyklus: system -> light -> dark -> system
      const currentIndex = THEME_STATES.indexOf(currentState)
      const nextIndex = (currentIndex + 1) % THEME_STATES.length
      currentState = THEME_STATES[nextIndex]

      // Speichern
      localStorage.setItem(STORAGE_KEY, currentState)

      // Anwenden
      applyThemeToDocument(currentState)
      updateButtonState(button, currentState)
    })
  })
</script>