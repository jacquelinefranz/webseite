---
import { Icon } from 'astro-icon/components';
import { CollectionEntry } from 'astro:content';

interface Props {
  /** Der aktuelle Theme-Modus ('light', 'dark', 'system'). */
  aktuellesThema?: 'light' | 'dark' | 'system';
}

const { aktuellesThema = 'system' } = Astro.props;

// Dynamischer Icon-Name basierend auf dem aktuellen Thema (aus dem Mingcute-Set)
let iconName: string;
switch (aktuellesThema) {
  case 'light':
    iconName = 'mingcute:sun-line';
    break;
  case 'dark':
    iconName = 'mingcute:moon-line';
    break;
  case 'system':
  default:
    iconName = 'mingcute:monitor-line';
    break;
}
---

<button id="theme-toggle" aria-label="Theme wechseln" data-aktuelles-thema={aktuellesThema}>
  <Icon name={iconName} class="theme-icon" />
</button>

<style>
  button {
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--abstand-s);
    color: var(--textfarbe);
    transition: var(--uebergang-standard);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--abstand-s);
  }

  button:hover {
    background-color: var(--hintergrund-hellgrau);
  }

  .theme-icon {
    width: 1.5em;
    height: 1.5em;
  }
</style>

<script>
  // Dieses Skript läuft clientseitig, nachdem Astro die Komponente gerendert hat.
  document.addEventListener('DOMContentLoaded', () => {
    const themeToggle = document.getElementById('theme-toggle');
    if (!themeToggle) return;

    let aktuellesThema = themeToggle.dataset.aktuellesThema || 'system'; // Initialwert vom Server

    // Funktion zum Setzen des Themas und Aktualisieren des Icons
    const setzeThema = (thema: 'light' | 'dark' | 'system') => {
      aktuellesThema = thema;
      document.documentElement.setAttribute('data-theme', thema);
      const icon = themeToggle.querySelector('.theme-icon');
      if (icon) {
        let iconName;
        switch (thema) {
          case 'light':
            iconName = 'lucide:sun';
            break;
          case 'dark':
            iconName = 'lucide:moon';
            break;
          case 'system':
          default:
            iconName = 'lucide:monitor';
            break;
        }
        // Direkte DOM-Manipulation, um das 'name'-Attribut des Icon-Elements zu ändern
        icon.setAttribute('name', iconName); // astro-icon rendert dies als SVG
        themeToggle.dataset.aktuellesThema = thema; // Datenattribut aktualisieren
      }
      localStorage.setItem('theme', thema); // Thema im localStorage speichern
    };

    // Beim Laden der Seite: Thema aus localStorage lesen oder System bevorzugen
    const gespeichertesThema = localStorage.getItem('theme') as 'light' | 'dark' | 'system';
    if (gespeichertesThema) {
      setzeThema(gespeichertesThema);
    } else {
      // Wenn nichts im localStorage, aber Astro hat ein initiales aktuellesThema gesetzt
      // (z.B. vom Server aus basierend auf einer Session oder Default), dann nutzen wir das.
      // Ansonsten wird "system" verwendet (was der Default ist).
      setzeThema(aktuellesThema); // Nutzt den Wert vom Server oder den Default 'system'
    }

    // Event-Listener für den Toggle-Button
    themeToggle.addEventListener('click', () => {
      let neuesThema: 'light' | 'dark' | 'system';
      if (aktuellesThema === 'system') {
        neuesThema = 'light';
      } else if (aktuellesThema === 'light') {
        neuesThema = 'dark';
      } else {
        neuesThema = 'system';
      }
      setzeThema(neuesThema);
    });

    // Listener für Änderungen im System-Theme
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      if (aktuellesThema === 'system') {
        // Wenn der Benutzer "system" gewählt hat, passen wir uns an die Systemänderung an
        // Das setzeThema wird dann von der prefers-color-scheme im CSS gesteuert.
        // Wir müssen hier nur sicherstellen, dass das Icon korrekt ist, wenn aktuellesThema 'system' ist.
        setzeThema('system'); // Aktualisiert das Icon auf 'monitor'
      }
    });
  });
</script>
